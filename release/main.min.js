var __reflect=this&&this.__reflect||function(t,e,i){t.__class__=e,i?i.push(e):i=[e],t.__types__=t.__types__?i.concat(t.__types__):i},__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},Loading=function(t){function e(){var e=t.call(this)||this;return e.addEventListener(egret.Event.ADDED,e.init,e),e}return __extends(e,t),e.prototype.init=function(t){this.removeEventListener(egret.Event.ADDED,this.init,this),null==this.heart&&(this.createbg(),this.createText(),this.createHeart()),this.startMove()},e.prototype.createbg=function(){var t=new egret.Shape;t.graphics.beginFill(16559439,.8),t.graphics.drawRect(0,0,this.stage.stageWidth,this.stage.stageHeight),t.graphics.endFill(),this.addChild(t)},e.prototype.createText=function(){var t=new egret.Bitmap;t.texture=RES.getRes("loading"),this.addChild(t),t.x=(this.stage.stageWidth-t.width)/2,t.y=this.stage.stageHeight/2+100},e.prototype.createHeart=function(){this.heart=new egret.Bitmap,this.heart.texture=RES.getRes("loadingui"),this.addChild(this.heart),this.heart.anchorOffsetX=this.heart.width/2,this.heart.anchorOffsetY=this.heart.height/2,this.heart.x=this.stage.stageWidth/2,this.heart.y=this.stage.stageHeight/2},e.prototype.startMove=function(){egret.Tween.get(this.heart).to({scaleX:1.5,scaleY:1.5},700,egret.Ease.elasticOut).to({scaleX:1,scaleY:1},600,egret.Ease.elasticOut).call(this.startMove,this)},e}(egret.DisplayObjectContainer);__reflect(Loading.prototype,"Loading");var AnLogic=function(){function t(){}return t.Analysis=function(e){console.log(e);for(var i,n,s,o,r=[],a=0;a<e.length;a++)"male"==e[a].faceAttributes.gender?null==i?i=e[a]:parseFloat(i.faceAttributes.smile)<parseFloat(e[a].faceAttributes.smile)?(null==n?n=i:parseFloat(n.faceAttributes.smile)<parseFloat(i.faceAttributes.smile)&&(n=i),i=e[a]):null==n?n=e[a]:parseFloat(n.faceAttributes.smile)<parseFloat(e[a].faceAttributes.smile)&&(n=e[a]):null==s?s=e[a]:parseFloat(s.faceAttributes.smile)<parseFloat(e[a].faceAttributes.smile)?(null==o?o=s:parseFloat(o.faceAttributes.smile)<parseFloat(s.faceAttributes.smile)&&(o=s),s=e[a]):null==o?o=e[a]:parseFloat(o.faceAttributes.smile)<parseFloat(e[a].faceAttributes.smile)&&(o=e[a]);return null!=i&&r.push(i),null!=s&&r.push(s),null!=n&&r.push(n),null!=o&&r.push(o),t.fenshu(parseFloat(r[0].faceAttributes.smile),parseFloat(r[0].faceAttributes.age),parseFloat(r[1].faceAttributes.smile),parseFloat(r[1].faceAttributes.age)),console.log(r),r},t.fenshu=function(e,i,n,s){.1>e&&(e*=10),.1>n&&(n*=10),t.FEN=(e+n)/2*80,t.FEN+=Math.abs(i-s)/(i+s)*20,t.FEN=10*Math.sqrt(t.FEN),t.FEN>=100&&(t.FEN=99)},t}();AnLogic.FEN=0,__reflect(AnLogic.prototype,"AnLogic");var Bar=function(){function t(){}return t.create=function(t,e,i){console.log(t,e,i);var n=new egret.DisplayObjectContainer,s=new egret.Bitmap,o=RES.getRes("bar");s.texture=o,n.addChild(s);var r=new egret.Bitmap;r.x=41,r.y=5,n.addChild(r),t>=0&&.1>t?r.texture=RES.getRes("s0"):t>=.1&&.2>t?r.texture=RES.getRes("s1"):t>=.2&&.3>t?r.texture=RES.getRes("s2"):t>=.3&&.4>t?r.texture=RES.getRes("s3"):t>=.4&&.5>t?r.texture=RES.getRes("s4"):t>=.5&&.6>t?r.texture=RES.getRes("s5"):t>=.6&&.7>=t?r.texture=RES.getRes("s6"):t>=.7&&8>t?r.texture=RES.getRes("s7"):t>=.8&&.9>t?r.texture=RES.getRes("s8"):t>=.9&&1>=t&&(r.texture=RES.getRes("s9"));var a,h=new egret.Bitmap;a="male"==e?RES.getRes("man"):RES.getRes("woman"),h.texture=a,h.x=10,h.y=72,n.addChild(h);var d=new egret.BitmapText;return d.font=RES.getRes("newnum_fnt"),d.text=Math.ceil(i).toString(),d.x=46,d.y=78,n.addChild(d),n},t}();__reflect(Bar.prototype,"Bar");var one;!function(t){function e(t){t.style.position="absolute",t.style.border="0",t.style.left="0px",t.style.top="0px"}var i=function(){function t(){}return t.initDOMRoot=function(i){var n=this,s=document.getElementById("egretDOMRoot");if(null==s){var o=document.getElementsByClassName("egret-player")[0];s=document.createElement("div"),e(s),s.setAttribute("id","egretDOMRoot"),o.appendChild(s),t.tempStage=i;var r=function(){var t=document.getElementsByClassName("egret-player")[0],e=t.getElementsByTagName("canvas")[0],i=t.getBoundingClientRect(),o=e.getBoundingClientRect(),r=!1,a=n.tempStage.orientation;a!=egret.OrientationMode.AUTO&&(r=a!=egret.OrientationMode.PORTRAIT&&i.height>i.width||a==egret.OrientationMode.PORTRAIT&&i.width>i.height);var h,d;r?(h=o.width/e.height,d=o.height/e.width):(h=o.width/e.width,d=o.height/e.height),s.style.left=e.style.left,s.style.top=e.style.top,s.style.transformOrigin="0% 0% 0px",s.style.transform=e.style.transform+" scale("+h+","+d+")"};this.tempStage.addEventListener(egret.Event.RESIZE,r,this),r()}},t.getDOMRoot=function(){var t=document.getElementById("egretDOMRoot");return t},t}();__reflect(i.prototype,"DOMRoot");var n=function(){function t(){this.lastMatrix=new egret.Matrix,this.lastWidth=0,this.lastHeight=0,this.node=document.createElement("div"),e(this.node)}return t.prototype.mapDisplayObject=function(t){this.dp=t},t.prototype.show=function(){i.initDOMRoot(this.dp.stage);var t=i.getDOMRoot();t.appendChild(this.node)},t.prototype.hide=function(){this.node&&this.node.parentNode&&this.node.parentNode.removeChild(this.node)},t.prototype.bind=function(t){this.unbind(),this.element=t,this.element.style.width="100%",this.element.style.height="100%",e(this.element),this.node.appendChild(t)},t.prototype.unbind=function(){this.element&&this.element.parentNode==this.node&&this.node.removeChild(this.element),this.element=null},t.prototype.updatePosition=function(){var t=this.dp;if(null!=t.stage){if(t.$renderNode.renderVisible=0==t.$renderNode.renderAlpha){if(this.element&&this.element.parentNode)return void this.element.parentNode.removeChild(this.element)}else this.element&&null==this.element.parentNode&&this.node.appendChild(this.element);var e=t.$renderNode.renderMatrix;if(this.lastMatrix.a!=e.a||this.lastMatrix.b!=e.b||this.lastMatrix.c!=e.c||this.lastMatrix.d!=e.d||this.lastMatrix.tx!=e.tx||this.lastMatrix.ty!=e.ty){var i=egret.web.getPrefixStyleName("transform");this.node.style.transformOrigin="0% 0% 0px",this.node.style[i]="matrix("+e.a+","+e.b+","+e.c+","+e.d+","+e.tx+","+e.ty+")",this.lastMatrix.a=e.a,this.lastMatrix.b=e.b,this.lastMatrix.c=e.c,this.lastMatrix.d=e.d,this.lastMatrix.tx=e.tx,this.lastMatrix.ty=e.ty}var n=t.width;this.lastWidth!=n&&(this.node.style.width=n+"px",this.lastWidth=n);var s=t.height;this.lastHeight!=s&&(this.node.style.height=s+"px",this.lastHeight=s)}},t}();t.DOMNode=n,__reflect(n.prototype,"one.DOMNode")}(one||(one={}));var HeartValue=function(t){function e(){var e=t.call(this)||this;return e.addEventListener(egret.Event.ADDED,e.init,e),e}return __extends(e,t),e.prototype.init=function(t){this.removeEventListener(egret.Event.ADDED,this.init,this),this.heart=new egret.Bitmap,this.heart.texture=RES.getRes("xin"),this.addChild(this.heart);var e=new egret.BitmapText;e.font=RES.getRes("ssfont_fnt"),e.text=Math.ceil(Math.ceil(AnLogic.FEN)).toString()+"%",e.x=(this.heart.width-e.width)/2,e.y=(this.heart.height-e.height)/2+10,this.addChild(e),this.anchorOffsetX=this.heart.width/2,this.anchorOffsetY=this.heart.height/2},e}(egret.DisplayObjectContainer);__reflect(HeartValue.prototype,"HeartValue");var ImageScene=function(t){function e(){var e=t.call(this)||this;return e.scale=0,e.maxW=877,e.maxH=300,e.addEventListener(egret.Event.ADDED,e.init,e),e}return __extends(e,t),e.prototype.init=function(t){this.removeEventListener(egret.Event.ADDED,this.init,this),this.node=new one.WebNode,this.maxH=this.stage.stageHeight-798},e.prototype.InitImage=function(t,e){var i=this;console.log("旋转",e),null!=this.photo&&(this.con.removeChildren(),this.rcon.removeChildren(),this.photo=null,this.con=null,this.rcon=null,this.removeChildren(),console.log("clear")),RES.getResByUrl(t,function(t){console.log(t),i.photo=new egret.Bitmap(t),i.photo.smoothing=!0,console.log(i.photo),egret.log("拍照的图",i.photo.width,i.photo.height),i.addChild(i.photo),i.drawCon()},this,RES.ResourceItem.TYPE_IMAGE)},e.prototype.drawCon=function(){null==this.con&&(this.con=new egret.DisplayObjectContainer,this.rcon=new egret.DisplayObjectContainer,this.rcon.addChild(this.con),this.addChild(this.rcon)),this.con.addChild(this.photo),console.log(this.photo.width/this.photo.height,this.maxW/this.maxH),this.photo.width/this.photo.height<this.maxW/this.maxH?this.scale=this.maxH/this.photo.height:this.scale=this.maxW/this.photo.width,this.con.scaleX=this.scale,this.con.scaleY=this.scale,this.con.x=(this.stage.stageWidth-this.con.width*this.scale)/2,this.con.y=444+(this.maxH-this.con.height*this.scale)/2;var t=new egret.Bitmap;t.texture=RES.getRes("kuang_png"),this.rcon.addChild(t),t.width=this.photo.width*this.scale+33,t.height=this.photo.height*this.scale+33,t.x=this.con.x-16,t.y=this.con.y-6},e.prototype.drawAnalysis=function(t,e){if(console.log(t),0==t.length){var i=new egret.Bitmap,n=RES.getRes("meilian_png");i.texture=n,i.x=(this.stage.stageWidth-i.width)/2,i.y=(this.stage.stageHeight-i.height)/2,this.rcon.addChild(i)}else{for(var s=0;s<t.length;s++)this.drawBorder(t[s]);this.drawbar(e),this.drawErweima();var o=new egret.Rectangle(0,0,this.stage.stageWidth,this.stage.stageHeight);o.height=this.con.y+this.con.height*this.scale+50;var r=document.createElement("img");this.node.bind(r),this.node.width=o.width,this.node.height=o.height,this.addChild(this.node);var a=new egret.RenderTexture;a.drawToTexture(this.stage,o),r.src=a.toDataURL("image/png"),this.succeeText()}},e.prototype.drawBorder=function(t){var e=new egret.Shape;e.graphics.lineStyle(2,16777215,.5),e.graphics.drawRect(this.con.x+this.scale*t.faceRectangle.left,this.con.y+this.scale*t.faceRectangle.top,this.scale*t.faceRectangle.width,this.scale*t.faceRectangle.height),e.graphics.endFill(),this.rcon.addChild(e)},e.prototype.drawbar=function(t){console.log("标签",t);var e=0;e=t.length>2?2:t.length;var i=[];console.log("长度",e);for(var n=0;e>n;n++){var s=Bar.create(parseFloat(t[n].faceAttributes.smile),t[n].faceAttributes.gender,parseInt(t[n].faceAttributes.age));s.x=this.con.x+this.scale*t[n].faceRectangle.left+(this.scale*t[n].faceRectangle.width-s.width)/2,s.y=this.con.y+this.scale*t[n].faceRectangle.top-140,i.push(new egret.Rectangle(s.x,s.y,s.width,s.height)),s.alpha=.85,this.rcon.addChild(s)}2==i.length&&this.linkHeart(i[0],i[1])},e.prototype.drawErweima=function(){var t=new egret.Bitmap;t.texture=RES.getRes("erweima_png"),this.rcon.addChild(t),t.width=150,t.height=150,t.x=this.con.x+this.con.width*this.scale-t.width,t.y=this.con.y+this.con.height*this.scale-t.height},e.prototype.linkHeart=function(t,e){var i=new HeartValue;this.rcon.addChild(i);var n=new egret.Point(t.x+t.width/2,t.y+t.height/2),s=new egret.Point(e.x+e.width/2,e.y+e.height/2),o=egret.Point.interpolate(n,s,.5);egret.Point.distance(n,s)<358&&(o.y-=170),i.x=o.x,i.y=o.y,i.alpha=.85;var r=new egret.Shape;r.graphics.lineStyle(5,15086387,.85),r.graphics.moveTo(n.x,n.y),r.graphics.curveTo(n.x,o.y,o.x,o.y),r.graphics.endFill(),this.rcon.addChildAt(r,this.rcon.numChildren-3);var a=new egret.Shape;a.graphics.lineStyle(5,15086387,.85),a.graphics.moveTo(s.x,s.y),a.graphics.curveTo(s.x,o.y,o.x,o.y),a.graphics.endFill(),this.rcon.addChildAt(a,this.rcon.numChildren-3)},e.prototype.succeeText=function(){var t=new egret.Bitmap;t.texture=RES.getRes("tishi"),this.rcon.addChild(t),t.x=(this.stage.stageWidth-t.width)/2,t.y=this.con.y+this.con.height*this.scale+50},e}(egret.DisplayObjectContainer);__reflect(ImageScene.prototype,"ImageScene");var BackgroundScene=function(t){function e(){var e=t.call(this)||this;return e.addEventListener(egret.Event.ADDED,e.init,e),e}return __extends(e,t),e.prototype.init=function(t){this.removeEventListener(egret.Event.ADDED,this.init,this),this.initbg(),this.initLogo(),this.initCovertop(),this.initButton()},e.prototype.initbg=function(){var t=new egret.Bitmap,e=RES.getRes("bg_jpg");t.texture=e,this.addChild(t)},e.prototype.initLogo=function(){this.logo=new egret.Bitmap;var t=RES.getRes("newlogo");console.log(t),this.logo.texture=t,this.logo.x=(this.stage.stageWidth-this.logo.width)/2,this.logo.y=this.stage.stageHeight-this.logo.height-10,this.addChild(this.logo)},e.prototype.initCovertop=function(){var t=new egret.Bitmap,e=RES.getRes("cover-top");t.texture=e,t.x=(this.stage.stageWidth-t.width)/2,t.y=10,this.addChild(t)},e.prototype.initButton=function(){var t=new egret.Bitmap,e=RES.getRes("button");t.texture=e,t.x=(this.stage.stageWidth-t.width)/2,t.y=this.logo.y-t.height-10,this.addChild(t),t.touchEnabled=!0,t.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.click,this)},e.prototype.click=function(t){this.dispatchEvent(t)},e}(egret.DisplayObjectContainer);__reflect(BackgroundScene.prototype,"BackgroundScene");var LoadingUI=function(t){function e(e,i){var n=t.call(this)||this;return n.createView(e,i),n}return __extends(e,t),e.prototype.createView=function(t,e){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.width=480,this.textField.height=100,this.textField.x=(t-480)/2,this.textField.y=(e-100)/2,this.textField.textAlign="center",this.textField.textColor=16777215},e.prototype.setProgress=function(t,e){var i=Math.round(t/e*100);this.textField.text="Loading..."+i+"%"},e}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI");var Main=function(t){function e(){var e=t.call(this)||this;return e.FACE_KEY="4535d56b0f2d4f76a3187055697838a5",e.addEventListener(egret.Event.ADDED_TO_STAGE,e.loading,e),e}return __extends(e,t),e.prototype.loading=function(t){this.loadingView=new LoadingUI(this.stage.stageWidth,this.stage.stageHeight),this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},e.prototype.onConfigComplete=function(t){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.loadGroup("preload")},e.prototype.onResourceProgress=function(t){"preload"==t.groupName&&this.loadingView.setProgress(t.itemsLoaded,t.itemsTotal)},e.prototype.onResourceLoadComplete=function(t){"preload"==t.groupName&&(this.stage.removeChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),this.init())},e.prototype.init=function(){this.removeEventListener(egret.Event.ADDED_TO_STAGE,this.init,this),this.ai=new MSAi,this.ai.addEventListener(egret.Event.COMPLETE,this.AI_complete,this),this.ai.addEventListener("error",this.AI_error,this),this.bg_scene=new BackgroundScene,this.addChild(this.bg_scene),this.bg_scene.addEventListener(egret.TouchEvent.TOUCH_TAP,this.click,this),this.s_scene=new StartScene,this.addChild(this.s_scene)},e.prototype.click=function(t){var e=this;egret.experimental.pickPhoto().then(function(t){e.showLoading();var i=e.base64ToArrayBuffer(t,"jpeg");e.nextStep(i,t,!1)})},e.prototype.base64ToArrayBuffer=function(t,e){e=e||t.match(/^data\:([^\;]+)\;base64,/im)[1]||"",t=t.replace(/^data\:([^\;]+)\;base64,/gim,"");for(var i=atob(t),n=i.length,s=new ArrayBuffer(n),o=new Uint8Array(s),r=0;n>r;r++)o[r]=i.charCodeAt(r);return s},e.prototype.showLoading=function(){null==this.loading_scene&&(this.loading_scene=new Loading),this.addChild(this.loading_scene)},e.prototype.nextStep=function(t,e,i){null==this.imgScene&&(this.imgScene=new ImageScene),null!=this.s_scene.parent&&this.removeChild(this.s_scene),this.addChildAt(this.imgScene,1),this.imgScene.InitImage(e,i),this.ai.face(this.FACE_KEY,t)},e.prototype.AI_complete=function(t){null!=this.loading_scene.parent&&this.removeChild(this.loading_scene),console.log(t.data),void 0==t.data.statusCode&&console.log("没有错误");var e=[];e=t.data.length>=2?AnLogic.Analysis(t.data):t.data,this.imgScene.drawAnalysis(t.data,e)},e.prototype.AI_error=function(t,e,i,n){console.warn("ai network error!"),null!=this.loading_scene.parent&&this.removeChild(this.loading_scene),this.s_scene.showError(),this.addChild(this.s_scene)},e}(egret.DisplayObjectContainer);__reflect(Main.prototype,"Main");var MSAi=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.face=function(t,e){null==this.faceReq&&(this.faceReq=new egret.HttpRequest,this.faceReq.addEventListener(egret.Event.COMPLETE,this.onFaceComplete,this),this.faceReq.addEventListener(egret.IOErrorEvent.IO_ERROR,this.netError,this)),this.faceReq.responseType=egret.HttpResponseType.TEXT,this.faceReq.open("https://api.cognitive.azure.cn/face/v1.0/detect?returnFaceId=true&returnFaceLandmarks=false&returnFaceAttributes=age,gender,smile",egret.HttpMethod.POST),this.faceReq.setRequestHeader("Content-Type","application/octet-stream"),this.faceReq.setRequestHeader("Ocp-Apim-Subscription-Key",t),this.faceReq.send(e)},e.prototype.onFaceComplete=function(t){var e=t.currentTarget,i=JSON.parse(e.response),n=new egret.Event(egret.Event.COMPLETE);n.data=i,this.dispatchEvent(n)},e.prototype.emotion=function(t,e){null==this.emotionReq&&(this.emotionReq=new egret.HttpRequest,this.emotionReq.addEventListener(egret.Event.COMPLETE,this.onEmotionComplete,this),this.emotionReq.addEventListener(egret.IOErrorEvent.IO_ERROR,this.netError,this)),this.emotionReq.responseType=egret.HttpResponseType.TEXT,this.emotionReq.open("https://westus.api.cognitive.microsoft.com/emotion/v1.0/recognize",egret.HttpMethod.POST),this.emotionReq.setRequestHeader("Content-Type","application/octet-stream"),this.emotionReq.setRequestHeader("Ocp-Apim-Subscription-Key",t),this.emotionReq.send(e)},e.prototype.onEmotionComplete=function(t){var e=t.currentTarget;egret.log("get data : ",e.response)},e.prototype.netError=function(t){console.log("网络错误信息：",t),this.dispatchEventWith("error")},e}(egret.EventDispatcher);__reflect(MSAi.prototype,"MSAi");var StartScene=function(t){function e(){var e=t.call(this)||this;return e.w=0,e.h=0,e.addEventListener(egret.Event.ADDED,e.init,e),e}return __extends(e,t),e.prototype.init=function(t){this.removeEventListener(egret.Event.ADDED,this.init,this),this.w=this.stage.stageWidth,this.h=this.stage.stageHeight;var e=new egret.Bitmap,i=RES.getRes("cover-bottom_png");e.texture=i,e.x=(this.stage.stageWidth-e.width)/2,e.y=434,this.addChild(e)},e.prototype.showError=function(){this.removeChildren();var t=new egret.Bitmap,e=RES.getRes("error_png");t.texture=e,t.x=(this.w-t.width)/2,t.y=(this.h-t.height)/2,this.addChild(t)},e}(egret.DisplayObjectContainer);__reflect(StartScene.prototype,"StartScene");var one;!function(t){var e=function(e){function i(){var i=e.call(this)||this;return i.domNode=new t.DOMNode,i.domNode.mapDisplayObject(i),i.addEventListener(egret.Event.ADDED_TO_STAGE,i.addToStage,i),i.addEventListener(egret.Event.REMOVED_FROM_STAGE,i.removeFromStage,i),i.$renderNode=new egret.sys.RenderNode,i}return __extends(i,e),i.prototype.bind=function(t){this.domNode.bind(t)},i.prototype.unbind=function(){this.domNode.unbind()},i.prototype.addToStage=function(){egret.Capabilities.runtimeType==egret.RuntimeType.WEB&&(this.domNode.show(),this.domNode.updatePosition(),this.tempStage=this.stage,this.tempStage.addEventListener(egret.Event.RESIZE,this.onResize,this))},i.prototype.removeFromStage=function(){this.tempStage.removeEventListener(egret.Event.RESIZE,this.onResize,this),this.domNode.hide(),this.tempStage=null},i.prototype.onResize=function(){this.domNode.updatePosition()},i.prototype.$update=function(t,i){var n=e.prototype.$update.call(this,t,i);return this.domNode.updatePosition(),n},i}(egret.DisplayObject);t.WebNode=e,__reflect(e.prototype,"one.WebNode")}(one||(one={}));